<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片互动展示</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="display-container">
        <h1>图片互动展示</h1>
        
        <div class="video-container">
            <video id="videoElement" autoplay playsinline></video>
            <canvas id="displayCanvas"></canvas>
        </div>
        
        <div class="controls">
            <a href="{{ url_for('main.index') }}" class="btn-back">返回首页</a>
        </div>
        
        <div id="statusMessage" class="status-message"></div>
    </div>

    <script src="{{ url_for('static', filename='js/image_storage.js') }}"></script>
    
    <!-- MediaPipe Hands - 优先使用本地文件，失败则尝试CDN -->
    <script>
        // MediaPipe库的本地路径（优先使用）
        const MEDIAPIPE_LOCAL = {
            name: 'local',
            hands: "{{ url_for('static', filename='lib/mediapipe/hands.js') }}",
            camera: "{{ url_for('static', filename='lib/mediapipe/camera_utils.js') }}",
            drawing: "{{ url_for('static', filename='lib/mediapipe/drawing_utils.js') }}",
            baseUrl: "{{ url_for('static', filename='lib/mediapipe/') }}"
        };
        
        // MediaPipe库的CDN地址（备选）
        const MEDIAPIPE_CDNS = [
            {
                name: 'jsdelivr',
                hands: 'https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1675469404/hands.js',
                camera: 'https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3.1675466867/camera_utils.js',
                drawing: 'https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3.1620248257/drawing_utils.js',
                baseUrl: 'https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1675469404/'
            },
            {
                name: 'unpkg',
                hands: 'https://unpkg.com/@mediapipe/hands@0.4.1675469404/hands.js',
                camera: 'https://unpkg.com/@mediapipe/camera_utils@0.3.1675466867/camera_utils.js',
                drawing: 'https://unpkg.com/@mediapipe/drawing_utils@0.3.1620248257/drawing_utils.js',
                baseUrl: 'https://unpkg.com/@mediapipe/hands@0.4.1675469404/'
            }
        ];

        // 加载脚本的函数
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                // 检查是否已经加载过
                const existingScript = document.querySelector(`script[src="${src}"]`);
                if (existingScript) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = src;
                script.async = false;
                script.onload = () => {
                    console.log(`成功加载: ${src}`);
                    resolve();
                };
                script.onerror = () => {
                    console.error(`加载失败: ${src}`);
                    script.remove();
                    reject(new Error(`加载失败: ${src}`));
                };
                document.head.appendChild(script);
            });
        }

        // 尝试加载MediaPipe（优先本地，失败则尝试CDN）
        async function loadMediaPipe() {
            // 首先尝试本地文件
            try {
                console.log('尝试从本地加载 MediaPipe 库...');
                await Promise.all([
                    loadScript(MEDIAPIPE_LOCAL.hands),
                    loadScript(MEDIAPIPE_LOCAL.camera),
                    loadScript(MEDIAPIPE_LOCAL.drawing)
                ]);
                console.log('✅ 成功从本地加载 MediaPipe');
                window.mediapipeCDN = 'local';
                window.mediapipeBaseUrl = MEDIAPIPE_LOCAL.baseUrl;
                window.mediapipeLoaded = true;
                return;
            } catch (error) {
                console.warn('❌ 本地MediaPipe库加载失败，将尝试CDN:', error.message);
                console.warn('提示：如果您已下载MediaPipe库，请确保文件放置在 static/lib/mediapipe/ 目录下');
            }
            
            // 本地加载失败，尝试CDN
            for (const cdn of MEDIAPIPE_CDNS) {
                try {
                    console.log(`尝试从 ${cdn.name} CDN 加载 MediaPipe...`);
                    await Promise.all([
                        loadScript(cdn.hands),
                        loadScript(cdn.camera),
                        loadScript(cdn.drawing)
                    ]);
                    console.log(`✅ 成功从 ${cdn.name} CDN 加载 MediaPipe`);
                    window.mediapipeCDN = cdn.name;
                    window.mediapipeBaseUrl = cdn.baseUrl;
                    window.mediapipeLoaded = true;
                    return;
                } catch (error) {
                    console.warn(`❌ ${cdn.name} CDN 加载失败:`, error.message);
                    // 继续尝试下一个CDN
                }
            }
            
            // 所有加载方式都失败
            throw new Error('无法加载MediaPipe库。\n\n解决方案：\n1. 下载MediaPipe库到本地（推荐）：\n   运行脚本: python scripts/download_mediapipe.py\n   或手动下载到: static/lib/mediapipe/\n\n2. 检查网络连接，确保可以访问CDN\n\n3. 如果问题持续，请查看下载说明: MEDIAPIPE_DOWNLOAD.md');
        }

        // 开始加载MediaPipe
        (async function() {
            try {
                await loadMediaPipe();
                // MediaPipe加载完成后，再加载hand_tracking.js
                const script = document.createElement('script');
                script.src = "{{ url_for('static', filename='js/hand_tracking.js') }}";
                document.body.appendChild(script);
            } catch (error) {
                console.error('MediaPipe加载失败:', error);
                const statusMsg = document.getElementById('statusMessage');
                if (statusMsg) {
                    statusMsg.textContent = 'MediaPipe库加载失败: ' + error.message;
                    statusMsg.className = 'status-message error';
                    statusMsg.style.display = 'block';
                }
            }
        })();
    </script>
</body>
</html>
