<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片互动展示</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="display-container">
        <h1>图片互动展示</h1>
        
        <div class="video-container">
            <video id="videoElement" autoplay playsinline></video>
            <canvas id="displayCanvas"></canvas>
        </div>
        
        <div class="controls">
            <a href="{{ url_for('main.index') }}" class="btn-back">返回首页</a>
        </div>
        
        <div id="statusMessage" class="status-message"></div>
    </div>

    <script src="{{ url_for('static', filename='js/image_storage.js') }}"></script>
    
    <!-- MediaPipe Hands - 使用脚本加载器，支持多个CDN备选 -->
    <script>
        // MediaPipe库的CDN地址（多个备选）
        const MEDIAPIPE_CDNS = [
            {
                name: 'jsdelivr',
                hands: 'https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1675469404/hands.js',
                camera: 'https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3.1675466867/camera_utils.js',
                drawing: 'https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3.1620248257/drawing_utils.js'
            },
            {
                name: 'unpkg',
                hands: 'https://unpkg.com/@mediapipe/hands@0.4.1675469404/hands.js',
                camera: 'https://unpkg.com/@mediapipe/camera_utils@0.3.1675466867/camera_utils.js',
                drawing: 'https://unpkg.com/@mediapipe/drawing_utils@0.3.1620248257/drawing_utils.js'
            }
        ];

        // 加载脚本的函数
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                // 检查是否已经加载过
                const existingScript = document.querySelector(`script[src="${src}"]`);
                if (existingScript) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = src;
                script.async = false;
                script.onload = () => {
                    console.log(`成功加载: ${src}`);
                    resolve();
                };
                script.onerror = () => {
                    console.error(`加载失败: ${src}`);
                    script.remove();
                    reject(new Error(`加载失败: ${src}`));
                };
                document.head.appendChild(script);
            });
        }

        // 尝试从多个CDN加载MediaPipe
        async function loadMediaPipe() {
            for (const cdn of MEDIAPIPE_CDNS) {
                try {
                    console.log(`尝试从 ${cdn.name} CDN 加载 MediaPipe...`);
                    await Promise.all([
                        loadScript(cdn.hands),
                        loadScript(cdn.camera),
                        loadScript(cdn.drawing)
                    ]);
                    console.log(`✅ 成功从 ${cdn.name} CDN 加载 MediaPipe`);
                    window.mediapipeCDN = cdn.name;
                    window.mediapipeLoaded = true;
                    return;
                } catch (error) {
                    console.warn(`❌ ${cdn.name} CDN 加载失败:`, error.message);
                    // 继续尝试下一个CDN
                }
            }
            throw new Error('所有CDN都无法加载MediaPipe库。请检查网络连接，或联系管理员。');
        }

        // 开始加载MediaPipe
        (async function() {
            try {
                await loadMediaPipe();
                // MediaPipe加载完成后，再加载hand_tracking.js
                const script = document.createElement('script');
                script.src = "{{ url_for('static', filename='js/hand_tracking.js') }}";
                document.body.appendChild(script);
            } catch (error) {
                console.error('MediaPipe加载失败:', error);
                const statusMsg = document.getElementById('statusMessage');
                if (statusMsg) {
                    statusMsg.textContent = 'MediaPipe库加载失败: ' + error.message;
                    statusMsg.className = 'status-message error';
                    statusMsg.style.display = 'block';
                }
            }
        })();
    </script>
</body>
</html>
