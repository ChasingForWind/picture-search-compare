<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡äº’åŠ¨åº”ç”¨ - ä¸Šä¼ å›¾ç‰‡</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>å›¾ç‰‡äº’åŠ¨åº”ç”¨</h1>
            <p class="subtitle">ä¸Šä¼ ä¸¤å¼ å›¾ç‰‡ï¼Œé€šè¿‡æ‰‹åŠ¿æ¢ç´¢å¯¹æ¯”æ•ˆæœ</p>
            <p class="subtitle" style="font-size: 0.9em; color: #999; margin-top: 5px;">
                ğŸ’¡ å›¾ç‰‡å­˜å‚¨åœ¨æ‚¨çš„æµè§ˆå™¨ä¸­ï¼Œåˆ·æ–°é¡µé¢åéœ€è¦é‡æ–°ä¸Šä¼ 
            </p>
        </header>

        <!-- ä¸Šä¼ è¡¨å• -->
        <section class="upload-section">
            <h2>ä¸Šä¼ å›¾ç‰‡</h2>
            <form id="uploadForm">
                <div class="form-group">
                    <label for="image1">ç¬¬ä¸€å¼ å›¾ç‰‡ï¼ˆèƒŒæ™¯å›¾ï¼‰</label>
                    <input type="file" id="image1" name="image1" accept="image/*" required>
                    <div class="preview" id="preview1"></div>
                </div>
                
                <div class="form-group">
                    <label for="image2">ç¬¬äºŒå¼ å›¾ç‰‡ï¼ˆå¯¹æ¯”å›¾ï¼‰</label>
                    <input type="file" id="image2" name="image2" accept="image/*" required>
                    <div class="preview" id="preview2"></div>
                </div>
                
                <div class="form-group">
                    <label for="description">æè¿°ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" id="description" name="description" placeholder="ä¾‹å¦‚ï¼šåŠå…¬æ¥¼æ–°æ—§å¯¹æ¯”">
                </div>
                
                <button type="submit" class="btn-primary" id="uploadBtn">
                    <span class="btn-text">å¼€å§‹å±•ç¤º</span>
                    <span class="btn-loading" style="display: none;">å¤„ç†ä¸­...</span>
                </button>
            </form>
            <div id="errorMessage" class="error-message" style="display: none;"></div>
        </section>
    </div>

    <script src="{{ url_for('static', filename='js/image_storage.js') }}"></script>
    <script>
        // å›¾ç‰‡é¢„è§ˆ
        document.getElementById('image1').addEventListener('change', function(e) {
            previewImage(e.target, 'preview1');
        });
        
        document.getElementById('image2').addEventListener('change', function(e) {
            previewImage(e.target, 'preview2');
        });

        function previewImage(input, previewId) {
            const preview = document.getElementById(previewId);
            preview.innerHTML = '';
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'preview-img';
                    preview.appendChild(img);
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // å‹ç¼©å›¾ç‰‡å‡½æ•°
        function compressImage(file, maxWidth = 1920, quality = 0.85) {
            return new Promise((resolve) => {
                // å¦‚æœæ–‡ä»¶å°äº2MBï¼Œç›´æ¥ä½¿ç”¨
                if (file.size < 2 * 1024 * 1024) {
                    resolve(file);
                    return;
                }

                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = function(e) {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // ç­‰æ¯”ä¾‹ç¼©æ”¾
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        } else if (height > maxWidth) {
                            width = (width * maxWidth) / height;
                            height = maxWidth;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        canvas.toBlob(resolve, 'image/jpeg', quality);
                    };
                };
            });
        }

        // è¡¨å•æäº¤ - ç›´æ¥åœ¨æµè§ˆå™¨å¤„ç†ï¼Œä¸ç»è¿‡æœåŠ¡å™¨
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const uploadBtn = document.getElementById('uploadBtn');
            const btnText = uploadBtn.querySelector('.btn-text');
            const btnLoading = uploadBtn.querySelector('.btn-loading');
            const errorMessage = document.getElementById('errorMessage');
            
            errorMessage.style.display = 'none';
            uploadBtn.disabled = true;
            btnText.style.display = 'none';
            btnLoading.style.display = 'inline';
            btnLoading.textContent = 'æ­£åœ¨å¤„ç†å›¾ç‰‡...';
            
            try {
                const image1File = document.getElementById('image1').files[0];
                const image2File = document.getElementById('image2').files[0];
                const description = document.getElementById('description').value.trim();
                
                if (!image1File || !image2File) {
                    throw new Error('è¯·é€‰æ‹©ä¸¤å¼ å›¾ç‰‡');
                }

                // æ£€æŸ¥æ–‡ä»¶å¤§å°
                const maxSize = 10 * 1024 * 1024; // 10MB
                if (image1File.size > maxSize || image2File.size > maxSize) {
                    throw new Error('å›¾ç‰‡æ–‡ä»¶å¤ªå¤§ï¼Œå•å¼ å›¾ç‰‡æœ€å¤§10MB');
                }

                // å‹ç¼©å›¾ç‰‡ï¼ˆå¦‚æœéœ€è¦ï¼‰
                btnLoading.textContent = 'æ­£åœ¨å‹ç¼©å›¾ç‰‡...';
                const [compressed1, compressed2] = await Promise.all([
                    compressImage(image1File),
                    compressImage(image2File)
                ]);

                // ä¿å­˜åˆ°æµè§ˆå™¨å­˜å‚¨
                btnLoading.textContent = 'æ­£åœ¨ä¿å­˜...';
                await imageStorage.init();
                const pairId = await imageStorage.saveImagePair(compressed1, compressed2, description);

                // è·³è½¬åˆ°å±•ç¤ºé¡µé¢
                window.location.href = `/display?id=${pairId}`;
                
            } catch (error) {
                console.error('Error:', error);
                errorMessage.textContent = 'å¤„ç†å¤±è´¥ï¼š' + error.message;
                errorMessage.style.display = 'block';
                uploadBtn.disabled = false;
                btnText.style.display = 'inline';
                btnLoading.style.display = 'none';
            }
        });
    </script>
</body>
</html>
